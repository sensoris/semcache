# Build stage
FROM ghcr.io/sensoris/faiss-base-image:latest AS builder

WORKDIR /app
COPY . .

RUN rustup default stable

# Build everything including test binaries
RUN cargo build --all-targets

# Runtime test image
FROM debian:bookworm-slim AS test-runtime

RUN apt-get update && apt-get install -y --no-install-recommends \
    libopenblas0 \
    ca-certificates \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/*

# Copy FAISS and Rust binaries
COPY --from=builder /usr/local /usr/local
COPY --from=builder /app /app

ENV LD_LIBRARY_PATH="/usr/local/lib"
WORKDIR /app

CMD ["cargo", "test", "--all-features", "--", "--nocapture"]
